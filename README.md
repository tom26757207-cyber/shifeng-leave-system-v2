# 秝豐居家長照 - 請假管理系統 v4.0 Final Complete

## 🎯 四大核心功能全部完成

| 功能 | 狀態 | 說明 |
|------|------|------|
| 1️⃣ 串接前端表格 + 員工自動完成 | ✅ 完成 | 輸入姓名自動搜尋，點選後帶入編號 |
| 2️⃣ LINE 推送通知 | ✅ 完成 | 提交後推送至群組 `C2ae9ba512e6f203375e0cb3ea699ef8d` |
| 3️⃣ 統計功能（可選年月） | ✅ 完成 | 詳細統計算薪用，不寫入工作表 |
| 4️⃣ 單筆列印表單 | ✅ 完成 | PDF 下載，記錄列印次數 |

---

## 📦 檔案說明

```
shifeng-v4-final-complete/
├── google-apps-script-complete.js  ← 後端完整程式碼（貼到 Apps Script）
├── 完整部署指南.md                  ← 詳細部署步驟與除錯
└── README.md                        ← 本檔案（快速參考）
```

---

## 🚀 快速部署（3 步驟）

### Step 1：更新後端
1. 打開 Google Sheets → `擴充功能` → `Apps Script`
2. 刪除舊程式碼，貼上 `google-apps-script-complete.js` 的完整內容
3. **修改第 30-31 行**：
   ```javascript
   const LINE_CHANNEL_ACCESS_TOKEN = '你的 LINE Token';  // 不變
   const LINE_GROUP_ID = 'C2ae9ba512e6f203375e0cb3ea699ef8d'; // ✅ 已更新
   ```
4. 儲存 → 部署為「網路應用程式」→ 複製網址

### Step 2：設定前端
1. 打開前端 `script.js`
2. 修改 `SCRIPT_URL` 為剛才複製的網址
3. 儲存

### Step 3：測試
- ✅ 連線狀態：右上角綠點
- ✅ 員工自動完成：輸入「王允」出現下拉
- ✅ LINE 推送：選單 → 測試 LINE 通知
- ✅ 列印：選單 → 列印選定的請假單
- ✅ 統計：選單 → 請假統計（選擇年月）

---

## 📊 統計功能使用方式

1. 在 Google Sheets 點擊 `📋 請假管理` → `📊 請假統計（選擇年月）`
2. 選擇年月（例如：**____2026____年____1____月**）
3. 點擊「查詢統計」

**顯示內容：**
- 📊 總筆數、總天數、總時數
- 📌 請假類別分布（事假、病假、特休...）
- 👥 請假人次詳細統計（每人的日期、類別、天數、時數）

**注意：** 統計結果**不會寫入**工作表，僅供查詢算薪用

---

## 🔧 列印次數欄位修正

**v4.0 重要修正：**
- 列印次數欄位從 **R 欄（第 18 欄）** 改為 **Q 欄（第 17 欄）**
- 索引從 `data[17]` 改為 `data[16]`
- 如果之前有列印記錄在 R 欄，請手動複製到 Q 欄

---

## ❗ 常見問題速查

| 問題 | 解決方式 |
|------|----------|
| 右上角紅點/灰點 | 檢查 `SCRIPT_URL` 與部署設定 |
| 無員工下拉 | 確認「居服員基本資料」工作表存在，A 欄=編號，B 欄=姓名 |
| LINE 推送失敗 | 檢查 Token 與群組 ID，使用測試功能除錯 |
| 列印失效 | 確認已選擇資料列（非標題列） |
| 統計無資料 | 統計依據「填寫日期」（D 欄），檢查該年月是否有資料 |

---

## 📋 欄位索引對照表

| 欄位 | 名稱 | 索引 |
|------|------|------|
| A | 請假單編號 | data[0] |
| B | 員工編號 | data[1] |
| C | 員工姓名 | data[2] |
| D | 填寫日期 | data[3] |
| E | 請假日期(起) | data[4] |
| F | 天數 | data[5] |
| G | 時數 | data[6] |
| H | 請假類別 | data[7] |
| I | 請假事由 | data[8] |
| J | 影響個案 | data[9] |
| K | 交接完成 | data[10] |
| L | 備註 | data[11] |
| M | 系統記錄時間 | data[12] |
| N | 核准督導 | data[13] |
| O | 核准主管 | data[14] |
| P | 居服員簽名 | data[15] |
| Q | 列印次數 | data[16] | ← ✅ v4.0 修正

---

## 🆚 版本對比

| 版本 | 問題 | v4.0 修正 |
|------|------|-----------|
| v3.0 | LINE 群組 ID 錯誤 | ✅ 更新為 `C2ae9ba512e6f203375e0cb3ea699ef8d` |
| v3.0 | 列印次數欄位錯誤（R 欄） | ✅ 修正為 Q 欄 |
| v3.0 | 統計功能不夠詳細 | ✅ 加入每人天數/時數明細 |
| v3.0 | 程式碼版本混亂 | ✅ 統一為單一完整版本 |

---

## 📞 技術支援

問題回報請提供：
1. 錯誤訊息截圖
2. Apps Script Logger 日誌（`查看` → `執行記錄`）
3. 前端 Console 錯誤（F12 開發者工具）

---

**版本：** v4.0 Final Complete  
**更新日期：** 2026-01-19  
**狀態：** 四大功能全部完成 ✅
